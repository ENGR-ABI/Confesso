// gifler.js v0.1.0 - https://themadcreator.github.io/gifler/
!function(t){function e(r){if(i[r])return i[r].exports;var n=i[r]={exports:{},id:r,loaded:!1};return t[r].call(n.exports,n,n.exports,e),n.loaded=!0,n.exports}var i={};return e.m=t,e.c=i,e.p="",e(0)}([function(t,e,i){var r,n;r=[i(1)],n=function(t){window.gifler=function(e){"function"==typeof e&&(e=e());var i=t.deferred(),r=new XMLHttpRequest;return r.open("GET",e,!0),"responseType"in r&&(r.responseType="arraybuffer"),r.onload=function(){if(200!==this.status)return i.reject("gifler: server responded with code "+this.status),void 0;var e=new Uint8Array(this.response||this.responseBody);i.resolve(e.buffer)},r.onerror=function(){i.reject("gifler: could not load")},r.send(),{get:function(){var e=t.deferred(),r=t.deferred(),n=new Uint8Array,o=new t.Stream(n);return i.then(function(i){n=new Uint8Array(i);var s={buffer:n,getCanvas:function(){var i=s.frames[0],r=document.createElement("canvas"),n=r.getContext("2d"),o=document.createElement("canvas"),a=o.getContext("2d");return r.width=i.dims.width,r.height=i.dims.height,o.width=i.dims.width,o.height=i.dims.height,o.getContext("2d").putImageData(i.imageData,0,0),{element:r,context:n,frames:function(e){"function"==typeof e&&t.each(s.frames,function(t){a.putImageData(t.imageData,0,0),n.drawImage(o,0,0),e()})}}},frames:[]};e.then(function(){try{var e=t.parseGIF(o);t.decompressFrames(e,!0,function(i){t.each(i,function(t){var e=document.createElement("canvas").getContext("2d"),i=e.createImageData(t.dims.width,t.dims.height);i.data.set(t.patch),t.imageData=i}),s.frames=i,r.resolve(s)})}catch(i){o.pos=0,o.data=n,r.reject("gifler: parsing failed")}}),e.resolve(),r},frames:function(t,n){"function"==typeof n&&(this.get().then(function(e){var i=document.createElement("canvas").getContext("2d"),r=function(e,r){i.clearRect(0,0,t.width,t.height),i.putImageData(r.imageData,0,0),n(t.getContext("2d"),{buffer:i.canvas,image:i.canvas,dims:r.dims})};t.width===e.frames[0].dims.width&&t.height===e.frames[0].dims.height?t.getContext("2d").clearRect(0,0,t.width,t.height):t.width=e.frames[0].dims.width,t.height=e.frames[0].dims.height;var o=0,s=function a(){var t=e.frames[o];return o+=1,o>=e.frames.length&&(o=0),r(t.index,t),window.setTimeout(a,10*t.delay)};s()}),this)}}}}.apply(e,r),!(void 0!==n&&(t.exports=n))},function(t,e,i){var r,n;r=[],n=function(){var t={};t.Stream=function(t){this.data=t,this.len=this.data.length,this.pos=0,this.readByte=function(){if(this.pos>=this.data.length)throw new Error("Attempted to read past end of stream.");return t instanceof Uint8Array?t[this.pos++]:255&t.charCodeAt(this.pos++)},this.readBytes=function(t){for(var e=[],i=0;t>i;i++)e.push(this.readByte());return e},this.read=function(t){for(var e="",i=0;t>i;i++)e+=String.fromCharCode(this.readByte());return e},this.readUnsigned=function(){var t=this.readBytes(2);return(t[1]<<8)+t[0]}},t.deferred=function(){function t(t,e,i,r){return function(){return i!==e.status?void 0:(e.value=t.apply(e.value,arguments),e.status===i&&(e.status=r),e)}}var e={PENDING:1,RESOLVED:2,REJECTED:3},i={status:e.PENDING,value:null};return{resolve:t(function(t){return t},i,e.PENDING,e.RESOLVED),reject:t(function(t){throw t},i,e.PENDING,e.REJECTED),then:function(t,r){switch(i.status){case e.PENDING:throw Error("pending");case e.RESOLVED:return i.value=t(i.value);case e.REJECTED:if(r)try{return i.value=r(i.value)}catch(n){return i.value}throw i.value}}}},t.lzw=function(t){function e(t){for(var e=0,i=0;t>i;i++)e+=Math.pow(2,i);return e}function i(t){switch(t){case 2:return e(2);case 3:return e(3);case 4:return e(4);case 5:return e(5);case 6:return e(6);case 7:return e(7);default:throw new Error("Invalid min code size.")}}function r(t){if(0===t.data.length&&(t.done=!0),!(t.data.length<2))return t.data.shift()<<8|t.data.shift()}function n(t,e){if(e<0)throw new Error("Invalid code size.");return t>>e*8&255}function o(t,e,i){for(var r=n(t,i),o=i-1;o>=0;o--)e[o]=r}function s(t,e){for(var i=0,r=0;e>r;r++)i+=t[r]<<r;return i}var a=0,d=[-1],c=1,h=function(t,e){d[c]=e,c++,d[a]=e};return{decode:function(e,n){for(var c=t(i(e)),f=c+1,u=c+2,l=e+1,p=!1,g=[0,0,0,0],m=[],v={data:[],done:!1},_=0;n>_;_++)m.push([0,0,0,0]);for(var y=a,b=0,w=!1,k=0;!v.done;){if(w){var E=r(v);if(void 0===E)break;o(E,g,l),w=!1;for(var x=0;l>x;x++)m[k][x]=g[x];k+=1}else{var S=r(v);if(void 0===S)break;if(S===c){d.splice(1),h(t,i(e)),y=a,p=!1,w=!0;continue}if(S===f){v.done=!0;break}if(!p){var A=S;if(S<c)d[a]=A,y=A,b=1,h(t,s(m[A],b));else{if(S>=d.length)throw new Error("Invalid entry index: "+S);if(-1===d[S]){if(-1===y)throw new Error("Invalid entry index: "+S);d[S]=y,y=S,b++,h(t,s(m[y],b-1)+m[y][b-1])}else y=S,b=1,h(t,s(m[y],b))}}else{var M=S;if(M>=d.length&&(M=a),!p&&-1===d[M])throw new Error("Invalid entry index: "+M);y=M,b=1}p=d.length===4096}0===v.data.length&&(v.done=!0)}return m.slice(0,k)}}}(t.Stream),t.parseColorTable=function(e,i){for(var r=[],n=0;i>n;n++){var o=e.readBytes(3),s={r:o[0],g:o[1],b:o[2]};r.push(s)}return r},t.readSubBlocks=function(e){var i,r=[];do{var n=e.readByte();i=n,n>0&&(r=r.concat(e.readBytes(n)))}while(0!==i);return r},t.parseHeader=function(e){var i={};if(i.sig=e.read(3),i.ver=e.read(3),"GIF"!==i.sig)throw new Error("Not a GIF file.");i.width=e.readUnsigned(),i.height=e.readUnsigned();var r=e.readByte();return i.gctFlag=r>>7,i.colorRes=r>>4&7,i.sorted=r>>3&1,i.gctSize=e.readByte(),i.bgColor=e.readByte(),i.pixelAspectRatio=e.readByte(),i.gctSize?i.gct=t.parseColorTable(e,1<<i.gctSize+1):i.gct=[],i},t.parseImg=function(e,i){var r={};return r.leftPos=e.readUnsigned(),r.topPos=e.readUnsigned(),r.width=e.readUnsigned(),r.height=e.readUnsigned(),r.lctFlag=e.readByte()>>7,r.interlaced=r.lctFlag>>6&1,r.sorted=r.lctFlag>>5&1,r.reserved=r.lctFlag>>3&3,r.lctSize=r.lctFlag&7,r.lctFlag?r.lct=t.parseColorTable(e,1<<r.lctSize+1):r.lct=i.gct,r},t.parseBlock=function(e,i,r){var n={};switch(n.sentinel=e.readByte(),n.sentinel){case 33:n.type="ext",n.label=e.readByte();var o=function(t,e){var i=t.readByte();switch(i){case 249:var r={};if(r.type="gce",e.gce&&console.warn("Warning, multiple graphics extensions found."),r.label=i,r.blockSize=t.readByte(),r.fields=t.readByte(),r.delay=t.readUnsigned(),r.transparencyIndex=t.readByte(),r.terminator=t.readByte(),e.gce=r,!r.transparent){r.transparent=255&r.fields>>0;var n=t.data.slice(0,t.pos);for(var o in n)"G"===String.fromCharCode(n[o])&&"I"===String.fromCharCode(n[o+1])&&"F"===String.fromCharCode(n[o+2])&&(n[o+10]|=1)}return r;case 1:var s={};return s.type="com",s.label=i,s.comment=t.read(t.readByte()),s.terminator=t.readByte(),s;case 254:var a={};return a.type="pte",a.label=i,a.text=t.read(t.readByte()),a.terminator=t.readByte(),a;case 255:var d={};d.type="app",d.label=i,d.blockSize=t.readByte(),d.identifier=t.read(8),d.authCode=t.read(3),d.data=t.readSubBlocks(),e.app=d;break;default:console.warn("Unknown graphic extension: "+i.toString(16))}}(e,n);if(o)return o;break;case 44:n.type="img",n.img=t.parseImg(e,i),n.img.pixels=t.lzw.decode(e.readByte(),t.readSubBlocks(e));break;case 59:n.type="eof",r();break;default:throw new Error("Unknown block: "+n.sentinel)}return"eof"!==n.type&&(n.terminator=e.readByte()),n},t.parseGIF=function(e){var i,r={};r.frames=[];var n=!1,o=0,s=function(){}("undefined"!=typeof callback&&(s=callback),i=t.parseHeader(e));var a=i.gct;return function d(){var c;if(!n)try{c=t.parseBlock(e,i,function(){n=!0})}catch(h){n=!0}if(!n){if(c){switch(c.type){case"img":r.frames.push({dims:{top:c.img.topPos,left:c.img.leftPos,width:c.img.width,height:c.img.height},delay:i.gce.delay,disposal:i.gce.fields>>2&7,transparent:i.gce.transparent,transparent_index:i.gce.transparencyIndex,data:c.img.pixels,lct:c.img.lctFlag?c.img.lct:null,colorIndex:c.img.lctFlag||!a?null:o});var f=c.img.lctFlag?c.img.lct:a;o<f.length-1&&(o=f.length-1)}i.gce=null,window.setTimeout(d,0)}else window.setTimeout(d,0)}},r},t.decompressFrame=function(e,i,r){var n={};if(n.pixels=new Uint8Array(e.dims.width*e.dims.height),n.dims=e.dims,n.transparent=e.transparent,n.colorIndex=e.colorIndex,r)r(n);else{e.data.forEach(function(t,e){n.pixels[e]=t});var o=i[e.colorIndex];o&&o.forEach(function(t,e){var i=t;n.pixels[e]=i})}return n},t.decompressFrames=function(e,i,r){function n(){i?"function"==typeof r?r(a):a=a:"function"==typeof r?r():void 0}if(0===e.frames.length)return n(),[];for(var o={},s=e.frames.length,a=[],d=function(e){var i=e.pixels.length,r=new Uint8Array(4*i);e.transparent=!1;for(var n=0;i>n;n++){var s=4*n,a=e.pixels[n],d=o[a];r[s+0]=d.r,r[s+1]=d.g,r[s+2]=d.b,r[s+3]=255}return e.patch=r,e},c=function(e,i){e.delay=e.delay||100,e.dims||(e.dims={top:0,left:0,width:t.width,height:t.height});for(var r=e.pixels.length,n=new Uint8Array(4*r),o=0;r>o;o++){var s=4*o,a=e.pixels[o],d=i?[0,0,0,0]:o[a];a===e.transparent_index?(n[s+0]=0,n[s+1]=0,n[s+2]=0,n[s+3]=0):(n[s+0]=i&&i[a]?i[a].r:0,n[s+1]=i&&i[a]?i[a].g:0,n[s+2]=i&&i[a]?i[a].b:0,n[s+3]=255)}return e.patch=n,e},h=0;s>h;h++)!function(i){e.frames[i].gct?o=e.frames[i].gct:(e.frames[i].lct||e.gct)&&(o=e.frames[i].lct||e.gct),"function"==typeof r?t.decompressFrame(e.frames[i],o,function(t){a[i]=t,0===--s&&n()}):a[i]=t.decompressFrame(e.frames[i],o),0===--s&&n()}(h);return a},t.each=function(t,e){for(var i=0;i<t.length;i++)e(t[i],i)},t}.apply(e,r),!(void 0!==n&&(t.exports=n))}]);
